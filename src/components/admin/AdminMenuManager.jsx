
import React, { useEffect, useState } from "react";
import Axios from "axios";
import "../../css/AdminMenuManager.css";
import { API_BASE_URL } from "../../config"; 
import { UploadImageIntoServer } from "./uploadImage";


function AdminMenuManager() {
    const [menus, setMenus] = useState([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isEditModalOpen, setIsEditModalOpen] = useState(false);
    const [menuTypes, setMenuTypes] = useState([]);
    const [menuTypeMap, setMenuTypeMap] = useState({});

    const [newMenu, setNewMenu] = useState({
        menu_name: "",
        menu_price: "",
        menu_type_id: "",
        imageFile: "",
    });

    const [editMenu, setEditMenu] = useState(null);

    const handleAddMenu = async () => {
        try {
            console.log("๐ค Adding menu:", newMenu);

            const uploadedImageData = await UploadImageIntoServer(newMenu.imageFile);
            console.log("Uploaded image data:", uploadedImageData);

            const res = await Axios.post(
                `${API_BASE_URL}/create`,
                {
                    db_type: "mysql",
                    store_code: "tb_menu",
                    set: {
                        menu_name: newMenu.menu_name,
                        menu_type_id: parseInt(newMenu.menu_type_id),
                        menu_price: parseInt(newMenu.menu_price),
                        image: uploadedImageData.data.data.name,
                    },
                },
                { headers: { "Content-Type": "application/json" } }
            );

            console.log("โ Add Menu Response:", res.data);
            const msg = res.data?.message?.toLowerCase() || "";

            if (msg.includes("successfully created")) {
                alert("โ เปเบเบตเปเบกเปเบกเบเบนเบชเบณเปเบฅเบฑเบเปเบฅเปเบง");
                setIsModalOpen(false);
                fetchMenus();
                setNewMenu({
                    menu_name: "",
                    menu_price: "",
                    menu_type_id: "",
                    imageFile: "",
                });
            } else {
                alert("โ เปเบเบตเปเบกเปเบกเบเบนเบเปเปเบชเบณเปเบฅเบฑเบ: " + msg);
            }
        } catch (err) {
            console.error("โ addMenu error", err);
            alert("โ เปเบเบตเบเบเปเปเบเบดเบเบเบฒเบเปเบเบเบฒเบเปเบเบตเปเบกเปเบกเบเบน");
        }
    };

    const handleUpdateMenu = async () => {
        try {
            console.log("๐ค Updating menu:", editMenu);
            const res = await Axios.post(
                `${API_BASE_URL}/edit`,
                {
                    db_type: "mysql",
                    store_code: "tb_menu",
                    where: { menu_id: editMenu.menu_id },
                    set: {
                        menu_name: editMenu.menu_name,
                        menu_price: parseInt(editMenu.menu_price),
                        menu_type_id: parseInt(editMenu.menu_type_id),
                        image: editMenu.image,
                        menu_status: editMenu.menu_status,
                    },
                },
                { headers: { "Content-Type": "application/json" } }
            );

            console.log("โ Update Menu Response:", res.data);
            const msg = res.data?.message?.toLowerCase() || "";
            if (msg.includes("edited")) {
                alert("โ เปเบเปเปเบเปเบกเบเบนเบชเบณเปเบฅเบฑเบเปเบฅเปเบง");
                setIsEditModalOpen(false);
                fetchMenus();
            } else {
                alert("โ เบเปเปเบชเบฒเบกเบฒเบเปเบเปเปเบเปเบกเบเบนเปเบเป: " + msg);
            }
        } catch (error) {
            console.error("โ handleUpdateMenu error", error);
            alert("โ เปเบเบตเบเบเปเปเบเบดเบเบเบฒเบเบฅเบฐเบซเบงเปเบฒเบเบเบฒเบเบญเบฑเบเปเบเบเปเบกเบเบน");
        }
    };

    const fetchMenus = async () => {
        try {
            const res = await Axios.post(
                `${API_BASE_URL}/fetch`,
                {
                    db_type: "mysql",
                    store_code: "tb_menu",
                    field_list: "*",
                    where: "*",
                },
                { headers: { "Content-Type": "application/json" } }
            );
            console.log("๐ฅ Menus fetched:", res.data.data);
            setMenus(res.data.data || []);
        } catch (error) {
            console.error("โ fetchMenus error:", error);
        }
    };

    useEffect(() => {
        fetchMenus();
        const fetchMenuTypes = async () => {
            try {
                const res = await Axios.post(
                    `${API_BASE_URL}/fetch`,
                    {
                        db_type: "mysql",
                        store_code: "tb_menu_type",
                        field_list: "*",
                        where: "*",
                    },
                    { headers: { "Content-Type": "application/json" } }
                );

                const types = res.data.data || [];
                console.log("๐ฅ Menu types:", types);
                setMenuTypes(types);

                const map = {};
                types.forEach((t) => {
                    map[t.menu_type_id] = t.menu_type_name;
                });
                setMenuTypeMap(map);
            } catch (err) {
                console.error("โ fetchMenuTypes error", err);
            }
        };

        fetchMenuTypes();
    }, []);

    const deleteMenu = async (menuId) => {
        const confirmDelete = window.confirm(
            "เบเปเบฒเบเปเบเปเปเบเบเปเปเบงเปเบฒเบเปเบญเบเบเบฒเบเบฅเบถเบเปเบกเบเบนเบเบตเป?"
        );
        if (!confirmDelete) return;

        try {
            const res = await Axios.post(
                `${API_BASE_URL}/delete`,
                {
                    db_type: "mysql",
                    store_code: "tb_menu",
                    where: { menu_id: menuId },
                },
                { headers: { "Content-Type": "application/json" } }
            );

            console.log("๐๏ธ Delete response:", res.data);
            const msg = res.data?.message?.toLowerCase() || "";
            if (msg.includes("has been deleted")) {
                alert("โ เบฅเบถเบเปเบกเบเบนเบชเบณเปเบฅเบฑเบเปเบฅเปเบง");
                fetchMenus();
            } else {
                alert("โ เบฅเบถเบเปเบกเบเบนเบเปเปเบชเบณเปเบฅเบฑเบ: " + msg);
            }
        } catch (err) {
            console.error("โ deleteMenu error:", err);
            alert("โ เปเบเบตเบเบเปเปเบเบดเบเบเบฒเบเปเบเบเบฒเบเบฅเบถเบเปเบกเบเบน");
        }
    };
    return (
        <div className="menu-manager">
            <h2>เบเบฑเบเบเบฒเบเปเบกเบเบน</h2>
            <button className="add-btn" onClick={() => setIsModalOpen(true)}>
                โ เปเบเบตเปเบกเปเบกเบเบนเปเปเป
            </button>
            <div>
                <p>เปเบกเบเบนเบเบตเปเบเบถเบเบเบฒเบเบเบฒเบ: {menus.filter((menu) => menu.menu_status === "hidden").length}</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>เบฎเบนเบเบเบฒเบ</th>
                        <th>เบเบทเปเปเบกเบเบน</th>
                        <th>เบเบฐเปเบเบ</th>
                        <th>เบฅเบฒเบเบฒ</th>
                        <th>เบเบฒเบเบเบงเบเบเบธเบก</th>
                    </tr>
                </thead>
            
                <tbody>
                    {menus.map((menu) => (
                        <tr key={menu.menu_id}>
                            <td>
                                <img
                                    src={`http://localhost:5000/storages/images/${menu.image}`}
                                    alt={menu.menu_name}
                                    className="menu-img"
                                />
                            </td>
                            <td>{menu.menu_name}</td>
                            <td>{menuTypeMap[menu.menu_type_id] || menu.menu_type_id}</td>
                            <td>{Number(menu.menu_price).toLocaleString()} kip</td>
                            <td>
                                <button
                                    className="edit-btn"
                                    onClick={() => {
                                        setEditMenu(menu);
                                        setIsEditModalOpen(true);
                                    }}
                                >
                                    โ๏ธ
                                </button>
                                {menu.menu_status === "hidden" && (
                                    <span style={{ color: "red", marginLeft: "8px" }}>๐ซ เบเปเปเบชเบฐเปเบเบ</span>
                                )}
                                <button
                                    className="delete-btn"
                                    onClick={() => deleteMenu(menu.menu_id)}
                                >
                                    ๐๏ธ
                                </button>
                            </td>
                        </tr>
                    ))}
                </tbody>


            </table>

            {/* Modal เปเบเบตเปเบกเปเบกเบเบน */}
            {isModalOpen && (
                <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3>โ เปเบเบตเปเบกเปเบกเบเบนเปเปเป</h3>
                        <input
                            type="text"
                            placeholder="เบเบทเปเปเบกเบเบน"
                            value={newMenu.menu_name}
                            onChange={(e) =>
                                setNewMenu({ ...newMenu, menu_name: e.target.value })
                            }
                        />
                        <input
                            type="number"
                            placeholder="เบฅเบฒเบเบฒ"
                            value={newMenu.menu_price}
                            onChange={(e) =>
                                setNewMenu({ ...newMenu, menu_price: e.target.value })
                            }
                        />
                        <select
                            value={newMenu.menu_type_id}
                            onChange={(e) =>
                                setNewMenu({ ...newMenu, menu_type_id: e.target.value })
                            }
                        >
                            <option value="">เปเบฅเบทเบญเบเบเบฐเปเบเบ</option>
                            {menuTypes.map((type) => (
                                <option key={type.menu_type_id} value={type.menu_type_id}>
                                    {type.menu_type_name}
                                </option>
                            ))}
                        </select>
                        <input
                            type="file"
                            accept="image/*"
                            onChange={(e) => {
                                const file = e.target.files[0];
                                if (file) {
                                    setNewMenu({ ...newMenu, imageFile: file });
                                }
                            }}
                        />
                        {newMenu.image && (
                            <p
                                style={{
                                    fontSize: "14px",
                                    color: "#555",
                                    marginTop: "5px",
                                }}
                            >
                                ๐ เปเบเบฅเปเบเบตเปเปเบฅเบทเบญเบ: <strong>{newMenu.imageFile.name}</strong>
                            </p>
                        )}
                        <div style={{ marginTop: "10px" }}>
                            <button onClick={handleAddMenu} className="add-btn">
                                เบเบฑเบเบเบถเบ
                            </button>
                            <button
                                onClick={() => setIsModalOpen(false)}
                                className="delete-btn"
                            >
                                เบเบปเบเปเบฅเบตเบ
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Modal เปเบเปเปเบเปเบกเบเบน */}
            {isEditModalOpen && editMenu && (
                <div
                    className="modal-overlay"
                    onClick={() => setIsEditModalOpen(false)}
                >
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3>โ๏ธ เปเบเปเปเบเปเบกเบเบน</h3>

                        <input
                            type="text"
                            placeholder="เบเบทเปเปเบกเบเบน"
                            value={editMenu.menu_name}
                            onChange={(e) =>
                                setEditMenu({ ...editMenu, menu_name: e.target.value })
                            }
                        />

                        <input
                            type="number"
                            placeholder="เบฅเบฒเบเบฒ"
                            value={editMenu.menu_price}
                            onChange={(e) =>
                                setEditMenu({ ...editMenu, menu_price: e.target.value })
                            }
                        />

                        <select
                            value={editMenu.menu_type_id}
                            onChange={(e) =>
                                setEditMenu({ ...editMenu, menu_type_id: e.target.value })
                            }
                        >
                            {menuTypes.map((type) => (
                                <option key={type.menu_type_id} value={type.menu_type_id}>
                                    {type.menu_type_name}
                                </option>
                            ))}
                        </select>

                        <input
                            type="text"
                            placeholder="เบเบทเปเปเบเบฅเปเบฎเบนเบ เบเบปเบงเบขเปเบฒเบ abc.jpg"
                            value={editMenu.image}
                            onChange={(e) =>
                                setEditMenu({ ...editMenu, image: e.target.value })
                            }
                        />

                        {/* ๐ฝ Dropdown เนเธฅเธทเธญเธเธชเธเธฒเธเธฐเนเธกเธเธน */}
                        <select
                            value={editMenu.menu_status || "available"}
                            onChange={(e) =>
                                setEditMenu({ ...editMenu, menu_status: e.target.value })
                            }
                        >
                            <option value="available">๐ข เบชเบฐเปเบเบเปเบกเบเบน (Available)</option>
                            <option value="hidden">๐ซ เบเปเปเบชเบฐเปเบเบเปเบกเบเบน (Hidden)</option>
                        </select>

                        <div style={{ marginTop: "10px" }}>
                            <button onClick={handleUpdateMenu} className="edit-btn">
                                เบเบฑเบเบเบถเบ
                            </button>
                            <button
                                onClick={() => setIsEditModalOpen(false)}
                                className="delete-btn"
                            >
                                เบเบปเบเปเบฅเบตเบ
                            </button>
                        </div>
                    </div>
                </div>
            )}

        </div>
    );
}

export default AdminMenuManager;
